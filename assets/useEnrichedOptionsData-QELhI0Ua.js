import{r as g}from"./router-C0wDHNfv.js";import{P as k}from"./csv-B1Pu-2A6.js";import{t as B}from"./index-BVw2Pzxv.js";const M=()=>{const[D,m]=g.useState([]),[W,s]=g.useState(!1),[S,d]=g.useState(null),L=g.useCallback(async r=>{console.log("ðŸ“¥ Loading CSV:",r),s(!0),d(null);const l=[`https://raw.githubusercontent.com/datamilo/put-options-se/main/data/${r}?${Date.now()}`,`${window.location.origin}/put-options-sedata/${r}?${Date.now()}`];let f=null;for(const t of l)try{console.log("ðŸ”— Trying URL:",t);const c=await fetch(t);if(!c.ok)throw new Error(`Failed to fetch CSV: ${c.status} ${c.statusText}`);const a=await c.text();if(!a||a.trim().length===0)throw new Error("Empty CSV file received");console.log("âœ… Successfully loaded CSV from:",t);const o=await new Promise((e,p)=>{k.parse(a,{header:!0,skipEmptyLines:!0,transformHeader:P=>P.trim(),transform:(P,y)=>{if(typeof y=="string"&&["Premium","PoW_Simulation_Mean_Earnings","100k_Invested_Loss_Mean","1_2_3_ProbOfWorthless_Weighted","ProbWorthless_Bayesian_IsoCal","1_ProbOfWorthless_Original","2_ProbOfWorthless_Calibrated","3_ProbOfWorthless_Historical_IV","Lower_Bound_at_Accuracy","LossAtBadDecline","LossAtWorstDecline","PoW_Stats_MedianLossPct","PoW_Stats_WorstLossPct","PoW_Stats_MedianLoss","PoW_Stats_WorstLoss","PoW_Stats_MedianProbOfWorthless","PoW_Stats_MinProbOfWorthless","PoW_Stats_MaxProbOfWorthless","LossAt100DayWorstDecline","LossAt_2008_100DayWorstDecline","Mean_Accuracy","Lower_Bound_HistMedianIV_at_Accuracy","Lower_Bound","Lower_Bound_HistMedianIV","Bid_Ask_Mid_Price","Option_Price_Min","NumberOfContractsBasedOnLimit","Bid","ProfitLossPctLeastBad","Loss_Least_Bad","IV_AllMedianIV_Maximum100DaysToExp_Ratio","StockPrice","DaysToExpiry","AskBidSpread","Underlying_Value","StrikePrice","StockPrice_After_2008_100DayWorstDecline","LossAt50DayWorstDecline","LossAt_2008_50DayWorstDecline","ProfitLossPctBad","ProfitLossPctWorst","ProfitLossPct100DayWorst","ImpliedVolatility","TodayStockMedianIV_Maximum100DaysToExp","AllMedianIV_Maximum100DaysToExp","ExpiryDate_Lower_Bound_Minus_Pct_Based_on_Accuracy","Ask","WorstHistoricalDecline","BadHistoricalDecline","ImpliedVolatilityUntilExpiry","StockPrice_After_100DayWorstDecline","StockPrice_After_50DayWorstDecline","StockPrice_After_2008_50DayWorstDecline","100DayMaxPrice","50DayMaxPrice","Historical100DaysWorstDecline","Historical50DaysWorstDecline","2008_100DaysWorstDecline","2008_50DaysWorstDecline","IV_2sigma_Decline","BreakevenDecline","CVaR10pct_Decline"].includes(y)){const C=parseFloat(P);return isNaN(C)?null:C}return P},complete:P=>{if(P.errors.length>0){console.warn("CSV parsing warnings:",P.errors);const y=P.errors.filter(w=>w.type==="Delimiter"||w.type==="Quotes");if(y.length>0){p(new Error(`CSV parsing errors: ${y.map(w=>w.message).join(", ")}`));return}}P.data&&P.data.length>0?(console.log(`âœ… Parsed ${P.data.length} rows from CSV`),e(P.data)):(console.warn("No data found in CSV, trying next URL..."),p(new Error("No data found in CSV")))},error:P=>{p(new Error(`Failed to parse CSV: ${P.message}`))}})});m(o),s(!1);return}catch(c){console.warn(`âŒ Failed to load from ${t}:`,c),f=c;continue}console.warn("âŒ All CSV loading attempts failed, using mock data"),d(`Failed to load data from any source. Last error: ${f==null?void 0:f.message}`),u(),s(!1)},[]),_=g.useCallback(r=>{s(!0),d(null),k.parse(r,{header:!0,skipEmptyLines:!0,transformHeader:l=>l.trim(),transform:(l,f)=>{if(typeof f=="string"&&["Premium","PoW_Simulation_Mean_Earnings","100k_Invested_Loss_Mean","1_2_3_ProbOfWorthless_Weighted","ProbWorthless_Bayesian_IsoCal","1_ProbOfWorthless_Original","2_ProbOfWorthless_Calibrated","3_ProbOfWorthless_Historical_IV","Lower_Bound_at_Accuracy","LossAtBadDecline","LossAtWorstDecline","PoW_Stats_MedianLossPct","PoW_Stats_WorstLossPct","PoW_Stats_MedianLoss","PoW_Stats_WorstLoss","PoW_Stats_MedianProbOfWorthless","PoW_Stats_MinProbOfWorthless","PoW_Stats_MaxProbOfWorthless","LossAt100DayWorstDecline","LossAt_2008_100DayWorstDecline","Mean_Accuracy","Lower_Bound_HistMedianIV_at_Accuracy","Lower_Bound","Lower_Bound_HistMedianIV","Bid_Ask_Mid_Price","Option_Price_Min","NumberOfContractsBasedOnLimit","Bid","ProfitLossPctLeastBad","Loss_Least_Bad","IV_AllMedianIV_Maximum100DaysToExp_Ratio","StockPrice","DaysToExpiry","AskBidSpread","Underlying_Value","StrikePrice","StockPrice_After_2008_100DayWorstDecline","LossAt50DayWorstDecline","LossAt_2008_50DayWorstDecline","ProfitLossPctBad","ProfitLossPctWorst","ProfitLossPct100DayWorst","ImpliedVolatility","TodayStockMedianIV_Maximum100DaysToExp","AllMedianIV_Maximum100DaysToExp","ExpiryDate_Lower_Bound_Minus_Pct_Based_on_Accuracy","Ask","WorstHistoricalDecline","BadHistoricalDecline","ImpliedVolatilityUntilExpiry","StockPrice_After_100DayWorstDecline","StockPrice_After_50DayWorstDecline","StockPrice_After_2008_50DayWorstDecline","100DayMaxPrice","50DayMaxPrice","Historical100DaysWorstDecline","Historical50DaysWorstDecline","2008_100DaysWorstDecline","2008_50DaysWorstDecline"].includes(f)){const c=parseFloat(l);return isNaN(c)?null:c}return l},complete:l=>{l.errors.length>0?d(`CSV parsing errors: ${l.errors.map(f=>f.message).join(", ")}`):m(l.data),s(!1)},error:l=>{d(`Failed to parse CSV: ${l.message}`),s(!1)}})},[]),u=g.useCallback(()=>{console.log("ðŸ“¦ Loading mock data..."),m([{StockName:"AAK AB",OptionName:"AAK5T240",Premium:250,ExpiryDate:"2024-12-15","1_2_3_ProbOfWorthless_Weighted":.898455,ProbWorthless_Bayesian_IsoCal:.810947,"1_ProbOfWorthless_Original":.884279,"2_ProbOfWorthless_Calibrated":.85,"3_ProbOfWorthless_Historical_IV":.12,Lower_Bound_at_Accuracy:.75,LossAtBadDecline:-21150,LossAtWorstDecline:-25e3,PoW_Stats_MedianLossPct:.15,PoW_Stats_WorstLossPct:.25,PoW_Stats_MedianLoss:-18e3,PoW_Stats_WorstLoss:-3e4,PoW_Stats_MedianProbOfWorthless:.82,PoW_Stats_MinProbOfWorthless:.75,PoW_Stats_MaxProbOfWorthless:.95,LossAt100DayWorstDecline:-22e3,LossAt_2008_100DayWorstDecline:-45e3,Mean_Accuracy:.78,Lower_Bound_HistMedianIV_at_Accuracy:.22,Lower_Bound:195,Lower_Bound_HistMedianIV:.21,Bid_Ask_Mid_Price:248,Option_Price_Min:240,NumberOfContractsBasedOnLimit:400,Bid:245,ProfitLossPctLeastBad:.02,Loss_Least_Bad:-5e3,IV_AllMedianIV_Maximum100DaysToExp_Ratio:1.15,StockPrice:280,DaysToExpiry:45,AskBidSpread:10,Underlying_Value:280,StrikePrice:290,StockPrice_After_2008_100DayWorstDecline:220,LossAt50DayWorstDecline:-21150,LossAt_2008_50DayWorstDecline:-48910,ProfitLossPctBad:.02,ProfitLossPctWorst:.01,ProfitLossPct100DayWorst:.021,ImpliedVolatility:.298041,TodayStockMedianIV_Maximum100DaysToExp:.22951,AllMedianIV_Maximum100DaysToExp:.216361,ExpiryDate_Lower_Bound_Minus_Pct_Based_on_Accuracy:.2,StrikeBelowLowerAtAcc:"Y",Ask:255,"X-Day":0,PoW_Simulation_Mean_Earnings:12e3,"100k_Invested_Loss_Mean":-15e3,WorstHistoricalDecline:-.45,BadHistoricalDecline:-.35,ImpliedVolatilityUntilExpiry:.298,StockPrice_After_100DayWorstDecline:210,StockPrice_After_50DayWorstDecline:215,StockPrice_After_2008_50DayWorstDecline:180,"100DayMaxPrice":320,"50DayMaxPrice":310,Historical100DaysWorstDecline:-.42,Historical50DaysWorstDecline:-.38,"2008_100DaysWorstDecline":-.55,"2008_50DaysWorstDecline":-.52}])},[]);return g.useEffect(()=>{let r=!0;return(async()=>{if(r)try{await L("data.csv")}catch(f){console.warn("âŒ All CSV loading attempts failed:",f),r&&u()}})(),()=>{r=!1}},[L,u]),{data:D,isLoading:W,error:S,loadCSVFile:_,loadCSVFromGitHub:L,loadMockData:u,setData:m}},V=D=>{const{underlyingValue:m,transactionCost:W}=B();return g.useMemo(()=>(console.log("useRecalculatedOptions: Recalculating with underlyingValue:",m,"transactionCost:",W,"options count:",D.length),D.map(s=>{const S=Math.round(m/s.StrikePrice/100),d=(s.Bid+(s.Ask||s.Bid))/2,L=Math.round(d*S*100-W),_=u=>{if(u==null)return null;const r=s.StockPrice*(1+u);return Math.min(0,(r-s.StrikePrice)*S*100)};return{...s,originalPremium:s.Premium,recalculatedPremium:L,recalculatedNumberOfContracts:S,recalculatedBid_Ask_Mid_Price:d,Premium:L,NumberOfContractsBasedOnLimit:S,Bid_Ask_Mid_Price:d,LossAtIV2sigmaDecline:_(s.IV_2sigma_Decline),LossAtCVaR10pctDecline:_(s.CVaR10pct_Decline)}})),[D,m,W])};let i={data:[],isLoading:!1,error:null,loaded:!1};const h=()=>{const[D,m]=g.useState(i.data),[W,s]=g.useState(i.isLoading),[S,d]=g.useState(i.error);console.log("ðŸ” useIVData hook called, singleton loaded:",i.loaded,"data length:",i.data.length);const L=g.useCallback(async()=>{if(i.loaded&&i.data.length>0){console.log("ðŸš€ IV data already loaded in singleton, using cached data:",i.data.length),m(i.data),s(!1),d(i.error);return}console.log("ðŸ“¥ Loading IV data..."),s(!0),i.isLoading=!0,d(null),i.error=null;const _=[`https://raw.githubusercontent.com/datamilo/put-options-se/main/data/IV_PotentialDecline.csv?${Date.now()}`,`${window.location.origin}/put-options-sedata/IV_PotentialDecline.csv?${Date.now()}`];let u=null;for(const r of _)try{console.log("ðŸ”— Trying IV URL:",r);const l=await fetch(r);if(!l.ok)throw new Error(`Failed to fetch CSV: ${l.status} ${l.statusText}`);const f=await l.text();if(!f||f.trim().length===0)throw new Error("Empty CSV file received");console.log("âœ… Successfully loaded IV CSV from:",r),k.parse(f,{header:!0,skipEmptyLines:!0,delimiter:"|",transformHeader:t=>t.trim(),transform:(t,c)=>{const a=String(c||"");if(["IV_ClosestToStrike","IV_UntilExpiryClosestToStrike","LowerBoundClosestToStrike","LowerBoundDistanceFromCurrentPrice","LowerBoundDistanceFromStrike","ImpliedDownPct","ToStrikePct","SafetyMultiple","SigmasToStrike","ProbAssignment","CushionMinusIVPct"].includes(a)&&t!==""){const e=parseFloat(String(t));return isNaN(e)?0:e}return String(t||"").trim()},complete:t=>{if(t.errors.length>0){console.warn("IV CSV parsing warnings:",t.errors);const c=t.errors.filter(a=>a.type==="Delimiter"||a.type==="Quotes");if(c.length>0){d(`IV CSV parsing errors: ${c.map(a=>a.message).join(", ")}`),s(!1),i.isLoading=!1;return}}if(t.data&&t.data.length>0){console.log(`âœ… Parsed ${t.data.length} IV rows from CSV - STORING IN SINGLETON`);const c=t.data;i.data=c,i.loaded=!0,i.isLoading=!1,i.error=null,m(c),s(!1),d(null);return}else throw new Error("No IV data found in CSV")},error:t=>{throw new Error(`Failed to parse IV CSV: ${t.message}`)}});break}catch(l){console.warn(`âŒ Failed to load IV data from ${r}:`,l),u=l;continue}if(!i.loaded||i.data.length===0){console.warn("âŒ All IV CSV loading attempts failed, current singleton data length:",i.data.length);const r=`Failed to load IV data from any source. Last error: ${u==null?void 0:u.message}`;d(r),i.error=r}s(!1),i.isLoading=!1},[]);return g.useEffect(()=>{if(console.log("ðŸš€ useIVData useEffect triggered, singleton loaded:",i.loaded,"data length:",i.data.length),i.loaded&&i.data.length>0){console.log("ðŸ“‹ Using cached IV data from singleton:",i.data.length),m(i.data),s(i.isLoading),d(i.error);return}let _=!0;return(async()=>{if(!_){console.log("âš ï¸ Component unmounted, aborting load");return}console.log("ðŸ“¥ Starting IV data load...");try{await L()}catch(r){console.warn("âŒ useEffect: All IV CSV loading attempts failed:",r)}})(),()=>{_=!1}},[]),{data:D,isLoading:W,error:S,loadIVDataFromGitHub:L,setData:_=>{m(_),i.data=_,i.loaded=_.length>0}}};let n={data:[],isLoading:!1,error:null,loaded:!1};const E=()=>{const[D,m]=g.useState(n.data),[W,s]=g.useState(n.isLoading),[S,d]=g.useState(n.error);console.log("ðŸ” useMarginRequirementsData hook called, singleton loaded:",n.loaded,"data length:",n.data.length);const L=g.useCallback(async()=>{if(n.loaded&&n.data.length>0){console.log("ðŸš€ Margin data already loaded in singleton, using cached data:",n.data.length),m(n.data),s(!1),d(n.error);return}console.log("ðŸ“¥ Loading margin requirements data..."),s(!0),n.isLoading=!0,d(null),n.error=null;const _=[`https://raw.githubusercontent.com/datamilo/put-options-se/main/data/margin_requirements.csv?${Date.now()}`,`${window.location.origin}/put-options-sedata/margin_requirements.csv?${Date.now()}`];let u=null;for(const r of _)try{console.log("ðŸ”— Trying margin requirements URL:",r);const l=await fetch(r);if(!l.ok)throw new Error(`Failed to fetch CSV: ${l.status} ${l.statusText}`);const f=await l.text();if(!f||f.trim().length===0)throw new Error("Empty CSV file received");console.log("âœ… Successfully loaded margin requirements CSV from:",r),k.parse(f,{header:!0,skipEmptyLines:!0,delimiter:"|",transformHeader:t=>t.trim(),transform:(t,c)=>{const a=String(c||"");if(["Prob_Normal_2SD_Decline_Pct","Hist_Worst_Decline_Pct","SRI_Base","Event_Buffer","Final_SRI","OTM_Amount","Margin_A_Broker_Proxy","Margin_B_Historical_Floor","Margin_Floor_15pct","Est_Margin_SEK","Net_Premium_After_Costs","Annualized_ROM_Pct"].includes(a)&&t!==""){const e=parseFloat(String(t));return isNaN(e)?0:e}return String(t||"").trim()},complete:t=>{if(t.errors.length>0){console.warn("Margin CSV parsing warnings:",t.errors);const c=t.errors.filter(a=>a.type==="Delimiter"||a.type==="Quotes");if(c.length>0){d(`Margin CSV parsing errors: ${c.map(a=>a.message).join(", ")}`),s(!1),n.isLoading=!1;return}}if(t.data&&t.data.length>0){console.log(`âœ… Parsed ${t.data.length} margin requirements rows from CSV - STORING IN SINGLETON`);const c=t.data;n.data=c,n.loaded=!0,n.isLoading=!1,n.error=null,m(c),s(!1),d(null);return}else throw new Error("No margin requirements data found in CSV")},error:t=>{throw new Error(`Failed to parse margin CSV: ${t.message}`)}});break}catch(l){console.warn(`âŒ Failed to load margin data from ${r}:`,l),u=l;continue}if(!n.loaded||n.data.length===0){console.warn("âŒ All margin CSV loading attempts failed, current singleton data length:",n.data.length);const r=`Failed to load margin requirements data from any source. Last error: ${u==null?void 0:u.message}`;d(r),n.error=r}s(!1),n.isLoading=!1},[]);return g.useEffect(()=>{if(console.log("ðŸš€ useMarginRequirementsData useEffect triggered, singleton loaded:",n.loaded,"data length:",n.data.length),n.loaded&&n.data.length>0){console.log("ðŸ“‹ Using cached margin data from singleton:",n.data.length),m(n.data),s(n.isLoading),d(n.error);return}let _=!0;return(async()=>{if(!_){console.log("âš ï¸ Component unmounted, aborting margin data load");return}console.log("ðŸ“¥ Starting margin data load...");try{await L()}catch(r){console.warn("âŒ useEffect: All margin CSV loading attempts failed:",r)}})(),()=>{_=!1}},[]),{data:D,isLoading:W,error:S,loadMarginDataFromGitHub:L,setData:_=>{m(_),n.data=_,n.loaded=_.length>0}}},x=()=>{const{data:D,isLoading:m,error:W,...s}=M(),S=V(D),{data:d,isLoading:L,error:_}=h(),{data:u,isLoading:r,error:l}=E(),{underlyingValue:f,transactionCost:t}=B();return{data:g.useMemo(()=>S.length?(console.log("ðŸ”„ Enriching options data with IV and margin data...",{optionsDataLength:S.length,ivDataLength:d.length,marginDataLength:u.length}),S.map(a=>{const o=d.find(y=>y.OptionName===a.OptionName);o||console.log("âš ï¸ No IV data found for option:",a.OptionName);const e=u.find(y=>y.OptionName===a.OptionName);e||console.log("âš ï¸ No margin data found for option:",a.OptionName);let p=null;if(o!=null&&o.LowerBoundClosestToStrike){const y=a.NumberOfContractsBasedOnLimit||0,w=a.StrikePrice*y*100,C=y*o.LowerBoundClosestToStrike*100,A=C-w;p=a.Premium+A,p>=0&&(p=0),p<0&&(p=p-(p*75e-6+t)),a.OptionName==="HOLMB5U356"&&console.log("ðŸŽ¯ HOLMB5U356 Debug - Full Calculation:",{optionName:a.OptionName,strikePrice:a.StrikePrice,numberOfContracts:y,lowerBoundClosestToStrike:o.LowerBoundClosestToStrike,premium:a.Premium,transactionCost:t,"1_underlyingValueInvestment":w,"2_underlyingValueLowerBoundClosestToStrike":C,"3_lossLowerBoundClosestToStrike":A,"4_beforeTransactionCost":a.Premium+A,"5_potentialLossAtLowerBound_FINAL":p,expectedResult:-2402.8272,expectedCalc_step1:356*3*100,expectedCalc_step2:3*345.9*100,expectedCalc_step3:3*345.9*100-356*3*100,expectedCalc_step4:726+(3*345.9*100-356*3*100),expectedCalc_step5:726+(3*345.9*100-356*3*100)-((726+(3*345.9*100-356*3*100))*75e-6+99)})}let P=null;if(e!=null&&e.Est_Margin_SEK){const y=a.NumberOfContractsBasedOnLimit||0;P=Math.round(e.Est_Margin_SEK*y)}return{...a,IV_ClosestToStrike:(o==null?void 0:o.IV_ClosestToStrike)??void 0,IV_UntilExpiryClosestToStrike:(o==null?void 0:o.IV_UntilExpiryClosestToStrike)??void 0,LowerBoundClosestToStrike:(o==null?void 0:o.LowerBoundClosestToStrike)??void 0,LowerBoundDistanceFromCurrentPrice:(o==null?void 0:o.LowerBoundDistanceFromCurrentPrice)??void 0,LowerBoundDistanceFromStrike:(o==null?void 0:o.LowerBoundDistanceFromStrike)??void 0,ImpliedDownPct:(o==null?void 0:o.ImpliedDownPct)??void 0,ToStrikePct:(o==null?void 0:o.ToStrikePct)??void 0,SafetyMultiple:(o==null?void 0:o.SafetyMultiple)??void 0,SigmasToStrike:(o==null?void 0:o.SigmasToStrike)??void 0,ProbAssignment:(o==null?void 0:o.ProbAssignment)??void 0,SafetyCategory:(o==null?void 0:o.SafetyCategory)??void 0,CushionMinusIVPct:(o==null?void 0:o.CushionMinusIVPct)??void 0,Est_Margin_SEK:(e==null?void 0:e.Est_Margin_SEK)??void 0,Prob_Normal_2SD_Decline_Pct:(e==null?void 0:e.Prob_Normal_2SD_Decline_Pct)??void 0,Hist_Worst_Decline_Pct:(e==null?void 0:e.Hist_Worst_Decline_Pct)??void 0,SRI_Base:(e==null?void 0:e.SRI_Base)??void 0,Event_Buffer:(e==null?void 0:e.Event_Buffer)??void 0,Final_SRI:(e==null?void 0:e.Final_SRI)??void 0,OTM_Amount:(e==null?void 0:e.OTM_Amount)??void 0,Margin_A_Broker_Proxy:(e==null?void 0:e.Margin_A_Broker_Proxy)??void 0,Margin_B_Historical_Floor:(e==null?void 0:e.Margin_B_Historical_Floor)??void 0,Margin_Floor_15pct:(e==null?void 0:e.Margin_Floor_15pct)??void 0,Net_Premium_After_Costs:(e==null?void 0:e.Net_Premium_After_Costs)??void 0,Annualized_ROM_Pct:(e==null?void 0:e.Annualized_ROM_Pct)??void 0,PotentialLossAtLowerBound:p,EstTotalMargin:P}})):S,[S,d,u,f,t]),isLoading:m||L||r,error:W||_||l,...s}};export{x as u};
