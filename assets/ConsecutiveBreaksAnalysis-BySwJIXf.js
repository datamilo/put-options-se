import{j as e,N as q,L as M,I as A}from"./index-BVw2Pzxv.js";import{r as x,i as W,R as $}from"./router-C0wDHNfv.js";import{u as J}from"./usePageTitle-CpPgFbZv.js";import{P as K}from"./react-plotly-CsEramcV.js";import{u as Q}from"./useStockData-BWzV3G2_.js";import{u as U}from"./useVolatilityData-C2pxXklU.js";import{C as u,c as f,a as X,b as Z}from"./card-Dh7Q_ijz.js";import{S as E,a as z,b as Y,c as G,d as w}from"./select-CzhzUq9X.js";import{T as ee,a as te,b as V,c as F,d as ae,e as L}from"./table-W_lzODQg.js";import"./charts-B8eVsusH.js";import"./index-BAMY2Nnw.js";import"./csv-B1Pu-2A6.js";const se=()=>{const{allStockData:j}=Q(),[v,h]=x.useState(""),D=x.useMemo(()=>!j||j.length===0?[]:Array.from(new Set(j.map(s=>s.name))).filter(s=>s&&s.trim()!=="").sort(),[j]);x.useMemo(()=>{v===""&&D.length>0&&h(D[0])},[D,v]);const N=x.useCallback((s,l,r)=>s.filter(t=>{const i=new Date(t.date);return i>=l&&i<=r}),[]),k=x.useCallback((s,l)=>{const r=[];for(let t=0;t<s.length;t++){const i=new Date(s[t].date),c=new Date(i);c.setDate(c.getDate()-l);let d=0;for(let o=t;o>=0;o--){if(new Date(s[o].date)<c){d=o+1;break}o===0&&(d=0)}let n=1/0,a="";for(let o=d;o<=t;o++)s[o].low<n&&(n=s[o].low,a=s[o].date);r.push({date:s[t].date,open:s[t].open,high:s[t].high,low:s[t].low,close:s[t].close,volume:s[t].volume,rolling_low:n===1/0?null:n,last_break_date:n===1/0?null:a})}return r},[]),b=x.useCallback(s=>{const l=[];for(let r=1;r<s.length;r++)if(s[r].rolling_low&&s[r-1].rolling_low&&s[r].rolling_low<s[r-1].rolling_low){const t=l.length>0?Math.floor((new Date(s[r].date).getTime()-new Date(l[l.length-1].date).getTime())/864e5):null;l.push({date:s[r].date,prev_support:s[r-1].rolling_low,new_support:s[r].rolling_low,drop_pct:(s[r].rolling_low-s[r-1].rolling_low)/s[r-1].rolling_low*100,days_since:t})}return l},[]),_=x.useCallback((s,l)=>{if(s.length===0)return[];const r=[];let t=[s[0]],i=0;for(let c=1;c<s.length;c++){const d=new Date(s[c].date),n=new Date(s[c-1].date);if((d.getTime()-n.getTime())/(1e3*60*60*24)<=l)t.push(s[c]);else{if(t.length>0){const o=y(i,t);r.push(o),i++}t=[s[c]]}}if(t.length>0){const c=y(i,t);r.push(c)}return r},[]),y=(s,l)=>{const r=[];for(let d=1;d<l.length;d++){const n=(new Date(l[d].date).getTime()-new Date(l[d-1].date).getTime())/864e5;r.push(n)}const t=l.reduce((d,n)=>d+n.drop_pct,0),i=[...l.map(d=>d.drop_pct)].sort((d,n)=>d-n),c=i.length%2===0?(i[i.length/2-1]+i[i.length/2])/2:i[Math.floor(i.length/2)];return{id:s,breaks:l,num_breaks:l.length,start_date:l[0].date,end_date:l[l.length-1].date,duration_days:Math.floor((new Date(l[l.length-1].date).getTime()-new Date(l[0].date).getTime())/(1e3*60*60*24)),avg_gap:r.length>0?r.reduce((d,n)=>d+n)/r.length:void 0,min_gap:r.length>0?Math.min(...r):void 0,max_gap:r.length>0?Math.max(...r):void 0,total_drop:t,avg_drop:t/l.length,median_drop:c}},S=x.useCallback((s,l)=>{if(l.length===0)return null;const r=s.length,t=(r-l.length)/r*100,i=l.map(p=>p.drop_pct),c=i.reduce((p,C)=>p+C,0)/i.length,d=Math.min(...i),n=l.filter(p=>p.days_since!==null).map(p=>p.days_since),a=n.length>0?n.reduce((p,C)=>p+C,0)/n.length:null,o=n.length>0?n.sort((p,C)=>p-C)[Math.floor(n.length/2)]:null,m=n.length>0?Math.min(...n):null,g=n.length>0?Math.max(...n):null,B=new Date(l[l.length-1].date),P=new Date(s[s.length-1].date),I=Math.floor((P.getTime()-B.getTime())/(1e3*60*60*24)),R=new Date(l[0].date),H=new Date(s[0].date),O=Math.floor((R.getTime()-H.getTime())/(1e3*60*60*24));return{totalBreaks:l.length,stability:t,avgDrop:c,maxDrop:d,avgDaysBetween:a,medianDaysBetween:o,minDaysBetween:m,maxDaysBetween:g,daysSinceLastBreak:I,daysBeforeFirstBreak:O,tradingDaysPerBreak:r/l.length,firstBreakDate:l[0].date,lastBreakDate:l[l.length-1].date}},[]),T=x.useCallback((s,l)=>{const r=j.filter(m=>m.name===s).sort((m,g)=>new Date(m.date).getTime()-new Date(g.date).getTime());if(r.length===0)return null;let t=l.dateFrom,i=l.dateTo;t||(t=new Date(r[0].date)),i||(i=new Date(r[r.length-1].date)),N(r,t,i);const c=k(r,l.periodDays),d=N(c,t,i),n=b(d),a=_(n,l.maxGapDays),o=S(d,n);return{stockName:s,data:d,breaks:n,clusters:a,stats:o}},[j,N,k,b,_,S]);return{uniqueStocks:D,selectedStock:v,setSelectedStock:h,analyzeStock:T}},ue=()=>{J("Support Level Analysis");const[j]=W(),{uniqueStocks:v,selectedStock:h,setSelectedStock:D,analyzeStock:N}=se(),{volatilityData:k}=U(),[b,_]=x.useState(""),[y,S]=x.useState(""),[T,s]=x.useState("90"),[l,r]=x.useState("30");x.useEffect(()=>{const a=j.get("stock");a&&v.includes(a)&&D(a);const o=j.get("period");o&&["30","90","180","270","365"].includes(o)&&s(o)},[j,v,D]);const t=x.useMemo(()=>h?N(h,{dateFrom:b?new Date(b):null,dateTo:y?new Date(y):null,periodDays:parseInt(T),maxGapDays:parseInt(l)}):null,[h,b,y,T,l,N]);$.useEffect(()=>{if(t&&!b&&!y&&t.data.length>0){const a=t.data[t.data.length-1].date.split("T")[0],o=new Date(a),m=new Date(o);m.setFullYear(m.getFullYear()-1);const g=m.toISOString().split("T")[0];_(g),S(a)}},[t,b,y]);const i=x.useMemo(()=>!h||!t?[]:k.filter(o=>o.name===h).map(o=>{const m=t.data.find(g=>g.date.startsWith(o.date));return m?{date:m.date,price:m.high,type:o.type_of_event}:null}).filter(Boolean),[h,t,k]);if(v.length===0)return e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-4",children:e.jsx(u,{children:e.jsx(f,{className:"pt-6",children:e.jsx("p",{className:"text-muted-foreground",children:"Loading stock data..."})})})});const c=a=>a.split(" ")[0],d=t?[{type:"candlestick",x:t.data.map(a=>c(a.date)),open:t.data.map(a=>a.open),high:t.data.map(a=>a.high),low:t.data.map(a=>a.low),close:t.data.map(a=>a.close),name:"Price",increasing:{line:{color:"#0066CC"}},decreasing:{line:{color:"#CC3300"}}},{type:"scatter",mode:"lines",x:t.data.map(a=>c(a.date)),y:t.data.map(a=>a.rolling_low),name:"Rolling Low",line:{color:"#4B5563",width:2,dash:"dash"},customdata:t.data.map(a=>a.last_break_date),hovertemplate:"<b>Running Low:</b> %{y:.2f} kr<br><b>Running Low Date:</b> %{customdata|%Y-%m-%d}<extra></extra>"},{type:"scatter",mode:"markers",x:t.breaks.map(a=>c(a.date)),y:t.breaks.map(a=>a.new_support),name:"Support Broken",marker:{color:"#D97706",size:5,symbol:"circle"},text:t.breaks.map(a=>`Drop: ${a.drop_pct.toFixed(2)}%`),hovertemplate:"<b>%{x}</b><br>Support: %{y:.2f} kr<br>%{text}<extra></extra>"},...i.length>0?[{type:"scatter",mode:"markers",x:i.map(a=>c(a.date)),y:i.map(a=>a.price),name:"Earnings",marker:{color:"#991B1B",size:12,symbol:"circle-dot",line:{color:"#000000",width:1.5}},hovertemplate:"<b>%{x}</b><br>Earnings Event<extra></extra>"}]:[]]:[],n={title:t?`Support Breaks Timeline - ${h}`:"Support Breaks Timeline",yaxis:{title:"Price (kr)",autorange:!0},xaxis:{title:"Date",type:"category",tickangle:-45,tickmode:"linear",tick0:0,dtick:Math.max(1,Math.floor((t==null?void 0:t.data.length)/10)||1)},hovermode:"x unified",height:600,margin:{l:50,r:50,t:80,b:120},dragmode:"zoom"};return e.jsx("div",{className:"min-h-screen bg-background p-4 md:p-8",children:e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsxs("div",{className:"mb-8",children:[e.jsxs("h1",{className:"text-3xl md:text-4xl font-bold text-foreground mb-2 flex items-center gap-3",children:[e.jsx(q,{className:"h-8 w-8"}),"Support Level Analysis"]}),e.jsx("p",{className:"text-muted-foreground",children:"Analyze how well a stock's low is holding as support - tracking support breaks and clusters"})]}),e.jsx("div",{className:"bg-gray-50 dark:bg-gray-900 p-6 rounded-lg border border-gray-200 dark:border-gray-700 mb-8",children:e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4",children:[e.jsxs("div",{className:"flex flex-col space-y-2",children:[e.jsx(M,{htmlFor:"stock-select",className:"font-semibold",children:"Select Stock"}),e.jsxs(E,{value:h,onValueChange:D,children:[e.jsx(z,{id:"stock-select",children:e.jsx(Y,{})}),e.jsx(G,{children:v.map(a=>e.jsx(w,{value:a,children:a},a))})]})]}),e.jsxs("div",{className:"flex flex-col space-y-2",children:[e.jsx(M,{htmlFor:"date-from",className:"font-semibold",children:"From Date"}),e.jsx(A,{id:"date-from",type:"date",value:b,onChange:a=>_(a.target.value)})]}),e.jsxs("div",{className:"flex flex-col space-y-2",children:[e.jsx(M,{htmlFor:"date-to",className:"font-semibold",children:"To Date"}),e.jsx(A,{id:"date-to",type:"date",value:y,onChange:a=>S(a.target.value)})]}),e.jsxs("div",{className:"flex flex-col space-y-2",children:[e.jsx(M,{htmlFor:"period-select",className:"font-semibold",children:"Rolling Low Period"}),e.jsxs(E,{value:T,onValueChange:s,children:[e.jsx(z,{id:"period-select",children:e.jsx(Y,{})}),e.jsxs(G,{children:[e.jsx(w,{value:"30",children:"1-Month (30 days)"}),e.jsx(w,{value:"90",children:"3-Month (90 days)"}),e.jsx(w,{value:"180",children:"6-Month (180 days)"}),e.jsx(w,{value:"270",children:"9-Month (270 days)"}),e.jsx(w,{value:"365",children:"1-Year (365 days)"})]})]})]}),e.jsxs("div",{className:"flex flex-col space-y-2",children:[e.jsx(M,{htmlFor:"max-gap",className:"font-semibold",children:"Max Days Between Breaks"}),e.jsx(A,{id:"max-gap",type:"number",value:l,onChange:a=>r(a.target.value),min:"1",max:"90"})]})]})}),t&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-full bg-white dark:bg-gray-950 p-4 rounded-lg border border-gray-200 dark:border-gray-800 mb-8 overflow-hidden",children:e.jsx(K,{data:d,layout:n,config:{responsive:!0,displayModeBar:!0,displaylogo:!1},style:{width:"100%",height:"600px"}})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8",children:[e.jsx(u,{children:e.jsxs(f,{className:"pt-6",children:[e.jsx("div",{className:"text-sm font-medium text-gray-600",children:"Total Breaks"}),e.jsx("div",{className:"text-2xl font-bold text-orange-700",children:t.breaks.length})]})}),e.jsx(u,{children:e.jsxs(f,{className:"pt-6",children:[e.jsx("div",{className:"text-sm font-medium text-gray-600",children:"Total Clusters"}),e.jsx("div",{className:"text-2xl font-bold text-orange-700",children:t.clusters.length})]})}),e.jsx(u,{children:e.jsxs(f,{className:"pt-6",children:[e.jsx("div",{className:"text-sm font-medium text-gray-600",children:"Avg Breaks per Cluster"}),e.jsx("div",{className:"text-2xl font-bold text-orange-700",children:t.clusters.length>0?(t.breaks.length/t.clusters.length).toFixed(2):"0"})]})}),e.jsx(u,{children:e.jsxs(f,{className:"pt-6",children:[e.jsx("div",{className:"text-sm font-medium text-gray-600",children:"Multi-Break Clusters"}),e.jsx("div",{className:"text-2xl font-bold text-orange-700",children:t.clusters.filter(a=>a.num_breaks>1).length})]})}),e.jsx(u,{children:e.jsxs(f,{className:"pt-6",children:[e.jsx("div",{className:"text-sm font-medium text-gray-600",children:"Max Support Breaks"}),e.jsx("div",{className:"text-2xl font-bold text-orange-700",children:t.clusters.length>0?Math.max(...t.clusters.map(a=>a.num_breaks)):0})]})})]}),t.clusters.length>0&&e.jsxs("div",{className:"space-y-6 mb-8",children:[e.jsx("h2",{className:"text-2xl font-semibold",children:"All Break Clusters"}),t.clusters.map(a=>{const o=a.num_breaks>1?"ðŸ”´":"ðŸŸ¡",m=a.num_breaks===1?"break":"breaks";return e.jsxs(u,{className:"border-l-4 border-l-orange-500",children:[e.jsx(X,{className:"pb-3",children:e.jsxs(Z,{className:"text-base",children:[o," Cluster #",a.id,": ",a.num_breaks," ",m," (",a.start_date.split(" ")[0]," to ",a.end_date.split(" ")[0],")"]})}),e.jsxs(f,{children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-orange-50 p-3 rounded border border-orange-200",children:[e.jsx("div",{className:"text-xs text-gray-600 font-medium",children:"Duration"}),e.jsxs("div",{className:"text-lg font-bold text-orange-700",children:[a.duration_days," days"]})]}),a.avg_gap!==void 0&&e.jsxs("div",{className:"bg-orange-50 p-3 rounded border border-orange-200",children:[e.jsx("div",{className:"text-xs text-gray-600 font-medium",children:"Avg Gap"}),e.jsxs("div",{className:"text-lg font-bold text-orange-700",children:[a.avg_gap.toFixed(1)," days"]})]}),e.jsxs("div",{className:"bg-orange-50 p-3 rounded border border-orange-200",children:[e.jsx("div",{className:"text-xs text-gray-600 font-medium",children:"Total Drop"}),e.jsxs("div",{className:"text-lg font-bold text-orange-700",children:[a.total_drop.toFixed(2),"%"]})]}),e.jsxs("div",{className:"bg-orange-50 p-3 rounded border border-orange-200",children:[e.jsx("div",{className:"text-xs text-gray-600 font-medium",children:"Avg Drop per Break"}),e.jsxs("div",{className:"text-lg font-bold text-orange-700",children:[a.avg_drop.toFixed(2),"%"]})]}),e.jsxs("div",{className:"bg-orange-50 p-3 rounded border border-orange-200",children:[e.jsx("div",{className:"text-xs text-gray-600 font-medium",children:"Median Drop per Break"}),e.jsxs("div",{className:"text-lg font-bold text-orange-700",children:[a.median_drop.toFixed(2),"%"]})]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(ee,{children:[e.jsx(te,{children:e.jsxs(V,{className:"bg-orange-50",children:[e.jsx(F,{className:"text-orange-900",children:"Date"}),e.jsx(F,{className:"text-orange-900 text-right",children:"Previous Support"}),e.jsx(F,{className:"text-orange-900 text-right",children:"New Support"}),e.jsx(F,{className:"text-orange-900 text-right",children:"Drop %"}),e.jsx(F,{className:"text-orange-900",children:"Days Since"})]})}),e.jsx(ae,{children:a.breaks.map((g,B)=>{let P="-";if(B>0){const I=new Date(g.date),R=new Date(a.breaks[B-1].date);P=Math.floor((I.getTime()-R.getTime())/(1e3*60*60*24))+"d"}return e.jsxs(V,{className:"hover:bg-orange-50",children:[e.jsx(L,{className:"font-medium",children:g.date}),e.jsxs(L,{className:"text-right",children:[g.prev_support.toFixed(2)," kr"]}),e.jsxs(L,{className:"text-right",children:[g.new_support.toFixed(2)," kr"]}),e.jsxs(L,{className:"text-right font-semibold text-red-600",children:[g.drop_pct.toFixed(2),"%"]}),e.jsx(L,{children:P})]},B)})})]})})]})]},a.id)})]}),t.stats&&e.jsxs("div",{className:"mb-8",children:[e.jsx("h2",{className:"text-2xl font-semibold mb-4",children:"Support Break Statistics"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsx(u,{children:e.jsxs(f,{className:"pt-6",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-700 mb-2",children:"Total Breaks"}),e.jsx("div",{className:"text-2xl font-bold text-orange-700",children:t.stats.totalBreaks})]})}),e.jsx(u,{children:e.jsxs(f,{className:"pt-6",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-700 mb-2",children:"Days Since Last Break"}),e.jsxs("div",{className:"text-2xl font-bold text-orange-700",children:[t.stats.daysSinceLastBreak,"d"]})]})}),e.jsx(u,{children:e.jsxs(f,{className:"pt-6",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-700 mb-2",children:"Stability"}),e.jsxs("div",{className:"text-2xl font-bold text-orange-700",children:[t.stats.stability.toFixed(1),"%"]})]})}),e.jsx(u,{children:e.jsxs(f,{className:"pt-6",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-700 mb-2",children:"Trading Days per Break"}),e.jsx("div",{className:"text-2xl font-bold text-orange-700",children:t.stats.tradingDaysPerBreak.toFixed(0)})]})})]})]})]})]})})};export{ue as ConsecutiveBreaksAnalysis,ue as default};
