var Ee=s=>{throw TypeError(s)};var he=(s,t,r)=>t.has(s)||Ee("Cannot "+r);var n=(s,t,r)=>(he(s,t,"read from private field"),r?r.call(s):t.get(s)),D=(s,t,r)=>t.has(s)?Ee("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(s):t.set(s,r),N=(s,t,r,a)=>(he(s,t,"write to private field"),a?a.call(s,r):t.set(s,r),r),C=(s,t,r)=>(he(s,t,"access private method"),r);import{a0 as We,a1 as Be,a2 as _,a3 as me,a4 as ae,a5 as pe,a6 as fe,a7 as Te,a8 as Xe,a9 as ce,aa as qe,ab as Je,ac as Me,ad as ze,ae as $e,af as Ze,j as e,B as F,U as et,K as tt,M as st}from"./index-BVw2Pzxv.js";import{r as w}from"./router-C0wDHNfv.js";import{P as Ce}from"./csv-B1Pu-2A6.js";import{R as at,i as rt,C as it,X as nt,Y as Pe,T as ot,L as lt,b as ct,g as dt}from"./charts-B8eVsusH.js";import{P as ht}from"./react-plotly-CsEramcV.js";import{u as ut}from"./useStockData-BWzV3G2_.js";import{u as xt}from"./useVolatilityData-C2pxXklU.js";import{T as mt,a as pt,b as Le,c as Q,d as ft,e as H}from"./table-W_lzODQg.js";import{A as gt}from"./arrow-up-down-CgXERPoI.js";import{A as yt,a as bt}from"./arrow-up-sGc0pOJ_.js";import{S as jt,a as vt,b as St,c as wt,d as _e}from"./select-CzhzUq9X.js";import{C as $,a as K,b as V,c as Y}from"./card-Dh7Q_ijz.js";import{C as Ke}from"./circle-alert-Il3saIWk.js";import{T as Nt,a as Ct,b as ue,c as xe}from"./tabs-DAwOGdlE.js";import{A as Ie,a as Ae,b as Oe}from"./alert-Cl0GEkAX.js";import{I as kt}from"./info-CIZJMKHd.js";import"./index-BAMY2Nnw.js";var T,g,re,E,G,q,A,U,ie,J,Z,W,X,z,ee,v,se,ge,ye,be,je,ve,Se,we,Ve,Ue,Rt=(Ue=class extends We{constructor(t,r){super();D(this,v);D(this,T);D(this,g);D(this,re);D(this,E);D(this,G);D(this,q);D(this,A);D(this,U);D(this,ie);D(this,J);D(this,Z);D(this,W);D(this,X);D(this,z);D(this,ee,new Set);this.options=r,N(this,T,t),N(this,U,null),N(this,A,Be()),this.bindMethods(),this.setOptions(r)}bindMethods(){this.refetch=this.refetch.bind(this)}onSubscribe(){this.listeners.size===1&&(n(this,g).addObserver(this),Fe(n(this,g),this.options)?C(this,v,se).call(this):this.updateResult(),C(this,v,je).call(this))}onUnsubscribe(){this.hasListeners()||this.destroy()}shouldFetchOnReconnect(){return Ne(n(this,g),this.options,this.options.refetchOnReconnect)}shouldFetchOnWindowFocus(){return Ne(n(this,g),this.options,this.options.refetchOnWindowFocus)}destroy(){this.listeners=new Set,C(this,v,ve).call(this),C(this,v,Se).call(this),n(this,g).removeObserver(this)}setOptions(t){const r=this.options,a=n(this,g);if(this.options=n(this,T).defaultQueryOptions(t),this.options.enabled!==void 0&&typeof this.options.enabled!="boolean"&&typeof this.options.enabled!="function"&&typeof _(this.options.enabled,n(this,g))!="boolean")throw new Error("Expected enabled to be a boolean or a callback that returns a boolean");C(this,v,we).call(this),n(this,g).setOptions(this.options),r._defaulted&&!me(this.options,r)&&n(this,T).getQueryCache().notify({type:"observerOptionsUpdated",query:n(this,g),observer:this});const i=this.hasListeners();i&&Qe(n(this,g),a,this.options,r)&&C(this,v,se).call(this),this.updateResult(),i&&(n(this,g)!==a||_(this.options.enabled,n(this,g))!==_(r.enabled,n(this,g))||ae(this.options.staleTime,n(this,g))!==ae(r.staleTime,n(this,g)))&&C(this,v,ge).call(this);const o=C(this,v,ye).call(this);i&&(n(this,g)!==a||_(this.options.enabled,n(this,g))!==_(r.enabled,n(this,g))||o!==n(this,z))&&C(this,v,be).call(this,o)}getOptimisticResult(t){const r=n(this,T).getQueryCache().build(n(this,T),t),a=this.createResult(r,t);return Et(this,a)&&(N(this,E,a),N(this,q,this.options),N(this,G,n(this,g).state)),a}getCurrentResult(){return n(this,E)}trackResult(t,r){return new Proxy(t,{get:(a,i)=>(this.trackProp(i),r==null||r(i),i==="promise"&&(this.trackProp("data"),!this.options.experimental_prefetchInRender&&n(this,A).status==="pending"&&n(this,A).reject(new Error("experimental_prefetchInRender feature flag is not enabled"))),Reflect.get(a,i))})}trackProp(t){n(this,ee).add(t)}getCurrentQuery(){return n(this,g)}refetch({...t}={}){return this.fetch({...t})}fetchOptimistic(t){const r=n(this,T).defaultQueryOptions(t),a=n(this,T).getQueryCache().build(n(this,T),r);return a.fetch().then(()=>this.createResult(a,r))}fetch(t){return C(this,v,se).call(this,{...t,cancelRefetch:t.cancelRefetch??!0}).then(()=>(this.updateResult(),n(this,E)))}createResult(t,r){var O;const a=n(this,g),i=this.options,o=n(this,E),m=n(this,G),l=n(this,q),u=t!==a?t.state:n(this,re),{state:b}=t;let y={...b},c=!1,d;if(r._optimisticResults){const L=this.hasListeners(),te=!L&&Fe(t,r),ne=L&&Qe(t,a,r,i);(te||ne)&&(y={...y,...Je(b.data,t.options)}),r._optimisticResults==="isRestoring"&&(y.fetchStatus="idle")}let{error:S,errorUpdatedAt:h,status:x}=y;d=y.data;let j=!1;if(r.placeholderData!==void 0&&d===void 0&&x==="pending"){let L;o!=null&&o.isPlaceholderData&&r.placeholderData===(l==null?void 0:l.placeholderData)?(L=o.data,j=!0):L=typeof r.placeholderData=="function"?r.placeholderData((O=n(this,Z))==null?void 0:O.state.data,n(this,Z)):r.placeholderData,L!==void 0&&(x="success",d=Me(o==null?void 0:o.data,L,r),c=!0)}if(r.select&&d!==void 0&&!j)if(o&&d===(m==null?void 0:m.data)&&r.select===n(this,ie))d=n(this,J);else try{N(this,ie,r.select),d=r.select(d),d=Me(o==null?void 0:o.data,d,r),N(this,J,d),N(this,U,null)}catch(L){N(this,U,L)}n(this,U)&&(S=n(this,U),d=n(this,J),h=Date.now(),x="error");const f=y.fetchStatus==="fetching",k=x==="pending",M=x==="error",I=k&&f,P=d!==void 0,B={status:x,fetchStatus:y.fetchStatus,isPending:k,isSuccess:x==="success",isError:M,isInitialLoading:I,isLoading:I,data:d,dataUpdatedAt:y.dataUpdatedAt,error:S,errorUpdatedAt:h,failureCount:y.fetchFailureCount,failureReason:y.fetchFailureReason,errorUpdateCount:y.errorUpdateCount,isFetched:y.dataUpdateCount>0||y.errorUpdateCount>0,isFetchedAfterMount:y.dataUpdateCount>u.dataUpdateCount||y.errorUpdateCount>u.errorUpdateCount,isFetching:f,isRefetching:f&&!k,isLoadingError:M&&!P,isPaused:y.fetchStatus==="paused",isPlaceholderData:c,isRefetchError:M&&P,isStale:ke(t,r),refetch:this.refetch,promise:n(this,A),isEnabled:_(r.enabled,t)!==!1};if(this.options.experimental_prefetchInRender){const L=B.data!==void 0,te=B.status==="error"&&!L,ne=le=>{te?le.reject(B.error):L&&le.resolve(B.data)},De=()=>{const le=N(this,A,B.promise=Be());ne(le)},oe=n(this,A);switch(oe.status){case"pending":t.queryHash===a.queryHash&&ne(oe);break;case"fulfilled":(te||B.data!==oe.value)&&De();break;case"rejected":(!te||B.error!==oe.reason)&&De();break}}return B}updateResult(){const t=n(this,E),r=this.createResult(n(this,g),this.options);if(N(this,G,n(this,g).state),N(this,q,this.options),n(this,G).data!==void 0&&N(this,Z,n(this,g)),me(r,t))return;N(this,E,r);const a=()=>{if(!t)return!0;const{notifyOnChangeProps:i}=this.options,o=typeof i=="function"?i():i;if(o==="all"||!o&&!n(this,ee).size)return!0;const m=new Set(o??n(this,ee));return this.options.throwOnError&&m.add("error"),Object.keys(n(this,E)).some(l=>{const p=l;return n(this,E)[p]!==t[p]&&m.has(p)})};C(this,v,Ve).call(this,{listeners:a()})}onQueryUpdate(){this.updateResult(),this.hasListeners()&&C(this,v,je).call(this)}},T=new WeakMap,g=new WeakMap,re=new WeakMap,E=new WeakMap,G=new WeakMap,q=new WeakMap,A=new WeakMap,U=new WeakMap,ie=new WeakMap,J=new WeakMap,Z=new WeakMap,W=new WeakMap,X=new WeakMap,z=new WeakMap,ee=new WeakMap,v=new WeakSet,se=function(t){C(this,v,we).call(this);let r=n(this,g).fetch(this.options,t);return t!=null&&t.throwOnError||(r=r.catch(pe)),r},ge=function(){C(this,v,ve).call(this);const t=ae(this.options.staleTime,n(this,g));if(fe||n(this,E).isStale||!Te(t))return;const a=Xe(n(this,E).dataUpdatedAt,t)+1;N(this,W,ce.setTimeout(()=>{n(this,E).isStale||this.updateResult()},a))},ye=function(){return(typeof this.options.refetchInterval=="function"?this.options.refetchInterval(n(this,g)):this.options.refetchInterval)??!1},be=function(t){C(this,v,Se).call(this),N(this,z,t),!(fe||_(this.options.enabled,n(this,g))===!1||!Te(n(this,z))||n(this,z)===0)&&N(this,X,ce.setInterval(()=>{(this.options.refetchIntervalInBackground||qe.isFocused())&&C(this,v,se).call(this)},n(this,z)))},je=function(){C(this,v,ge).call(this),C(this,v,be).call(this,C(this,v,ye).call(this))},ve=function(){n(this,W)&&(ce.clearTimeout(n(this,W)),N(this,W,void 0))},Se=function(){n(this,X)&&(ce.clearInterval(n(this,X)),N(this,X,void 0))},we=function(){const t=n(this,T).getQueryCache().build(n(this,T),this.options);if(t===n(this,g))return;const r=n(this,g);N(this,g,t),N(this,re,t.state),this.hasListeners()&&(r==null||r.removeObserver(this),t.addObserver(this))},Ve=function(t){ze.batch(()=>{t.listeners&&this.listeners.forEach(r=>{r(n(this,E))}),n(this,T).getQueryCache().notify({query:n(this,g),type:"observerResultsUpdated"})})},Ue);function Dt(s,t){return _(t.enabled,s)!==!1&&s.state.data===void 0&&!(s.state.status==="error"&&t.retryOnMount===!1)}function Fe(s,t){return Dt(s,t)||s.state.data!==void 0&&Ne(s,t,t.refetchOnMount)}function Ne(s,t,r){if(_(t.enabled,s)!==!1&&ae(t.staleTime,s)!=="static"){const a=typeof r=="function"?r(s):r;return a==="always"||a!==!1&&ke(s,t)}return!1}function Qe(s,t,r,a){return(s!==t||_(a.enabled,s)===!1)&&(!r.suspense||s.state.status!=="error")&&ke(s,r)}function ke(s,t){return _(t.enabled,s)!==!1&&s.isStaleByTime(ae(t.staleTime,s))}function Et(s,t){return!me(s.getCurrentResult(),t)}var Ye=w.createContext(!1),Bt=()=>w.useContext(Ye);Ye.Provider;function Tt(){let s=!1;return{clearReset:()=>{s=!1},reset:()=>{s=!0},isReset:()=>s}}var Mt=w.createContext(Tt()),Pt=()=>w.useContext(Mt),Lt=(s,t,r)=>{const a=r!=null&&r.state.error&&typeof s.throwOnError=="function"?$e(s.throwOnError,[r.state.error,r]):s.throwOnError;(s.suspense||s.experimental_prefetchInRender||a)&&(t.isReset()||(s.retryOnMount=!1))},_t=s=>{w.useEffect(()=>{s.clearReset()},[s])},It=({result:s,errorResetBoundary:t,throwOnError:r,query:a,suspense:i})=>s.isError&&!t.isReset()&&!s.isFetching&&a&&(i&&s.data===void 0||$e(r,[s.error,a])),At=s=>{if(s.suspense){const r=i=>i==="static"?i:Math.max(i??1e3,1e3),a=s.staleTime;s.staleTime=typeof a=="function"?(...i)=>r(a(...i)):r(a),typeof s.gcTime=="number"&&(s.gcTime=Math.max(s.gcTime,1e3))}},Ot=(s,t)=>s.isLoading&&s.isFetching&&!t,Ft=(s,t)=>(s==null?void 0:s.suspense)&&t.isPending,He=(s,t,r)=>t.fetchOptimistic(s).catch(()=>{r.clearReset()});function Qt(s,t,r){var c,d,S,h;const a=Bt(),i=Pt(),o=Ze(),m=o.defaultQueryOptions(s);(d=(c=o.getDefaultOptions().queries)==null?void 0:c._experimental_beforeQuery)==null||d.call(c,m);const l=o.getQueryCache().get(m.queryHash);m._optimisticResults=a?"isRestoring":"optimistic",At(m),Lt(m,i,l),_t(i);const p=!o.getQueryCache().get(m.queryHash),[u]=w.useState(()=>new t(o,m)),b=u.getOptimisticResult(m),y=!a&&s.subscribed!==!1;if(w.useSyncExternalStore(w.useCallback(x=>{const j=y?u.subscribe(ze.batchCalls(x)):pe;return u.updateResult(),j},[u,y]),()=>u.getCurrentResult(),()=>u.getCurrentResult()),w.useEffect(()=>{u.setOptions(m)},[m,u]),Ft(m,b))throw He(m,u,i);if(It({result:b,errorResetBoundary:i,throwOnError:m.throwOnError,query:l,suspense:m.suspense}))throw b.error;if((h=(S=o.getDefaultOptions().queries)==null?void 0:S._experimental_afterQuery)==null||h.call(S,m,b),m.experimental_prefetchInRender&&!fe&&Ot(b,a)){const x=p?He(m,u,i):l==null?void 0:l.promise;x==null||x.catch(pe).finally(()=>{u.updateResult()})}return m.notifyOnChangeProps?b:u.trackResult(b)}function de(s,t){return Qt(s,Rt)}const Re="https://raw.githubusercontent.com/datamilo/put-options-se/main",Ht=()=>de({queryKey:["lowerBound","trends"],queryFn:async()=>{const s=await fetch(`${Re}/data/hit_rate_trends_by_stock.csv`);if(!s.ok)throw new Error("Failed to load trend data");const t=await s.text();return new Promise((r,a)=>{Ce.parse(t,{header:!0,dynamicTyping:{HitRate:!0,Total:!0},skipEmptyLines:!0,error:i=>a(i),complete:i=>{r(i.data)}})})},staleTime:1e3*60*60*24,gcTime:1e3*60*60*24*7}),Ut=()=>de({queryKey:["lowerBound","dailyPredictions"],queryFn:async()=>{const s=await fetch(`${Re}/data/all_stocks_daily_predictions.csv`);if(!s.ok)throw new Error("Failed to load daily predictions");const t=await s.text();return new Promise((r,a)=>{Ce.parse(t,{header:!0,delimiter:"|",dynamicTyping:{StockPrice:!0,LowerBound:!0,StrikePrice:!0},skipEmptyLines:!0,error:i=>a(i),complete:i=>{r(i.data)}})})},staleTime:1e3*60*60*24,gcTime:1e3*60*60*24*7}),zt=()=>de({queryKey:["lowerBound","expiryStats"],queryFn:async()=>{const s=await fetch(`${Re}/data/all_stocks_expiry_stats.csv`);if(!s.ok)throw new Error("Failed to load expiry stats");const t=await s.text();return new Promise((r,a)=>{Ce.parse(t,{header:!0,delimiter:"|",dynamicTyping:{LowerBound_Min:!0,LowerBound_Max:!0,LowerBound_Median:!0,LowerBound_Mean:!0,PredictionCount:!0,BreachCount:!0,ExpiryClosePrice:!0},skipEmptyLines:!0,error:i=>a(i),complete:i=>{r(i.data)}})})},staleTime:1e3*60*60*24,gcTime:1e3*60*60*24*7}),Ge=()=>{const s=Ht(),t=Ut(),r=zt();return de({queryKey:["lowerBound","all"],queryFn:()=>{if(!s.data||!t.data||!r.data)throw new Error("Data not loaded");const a=new Map;r.data.forEach(d=>{const S=a.get(d.Stock)||0;a.set(d.Stock,S+1)});const i=Array.from(new Set(t.data.map(d=>d.Stock).filter(d=>(a.get(d)||0)>=6))).sort(),o=r.data,m=o.reduce((d,S)=>d+S.BreachCount,0),l=o.reduce((d,S)=>d+S.PredictionCount,0),p=l>0?(l-m)/l*100:0,u=t.data.map(d=>new Date(d.ExpiryDate)).sort((d,S)=>d.getTime()-S.getTime()),b=u.length>0?u[0].toISOString().split("T")[0]:"",y=u.length>0?u[u.length-1].toISOString().split("T")[0]:"",c={totalOptions:l,totalStocks:i.length,overallHitRate:Math.round(p*100)/100,dateRangeStart:b,dateRangeEnd:y,totalBreaches:m};return{dailyPredictions:t.data,expiryStats:r.data,monthlyTrends:s.data,stocks:i,summaryMetrics:c,lastUpdated:new Date}},enabled:s.isSuccess&&t.isSuccess&&r.isSuccess,staleTime:1e3*60*60*24,gcTime:1e3*60*60*24*7})},$t=s=>{const{data:t,...r}=Ge();return{...r,data:t?{stock:s,dailyPredictions:t.dailyPredictions.filter(a=>a.Stock===s),expiryStats:t.expiryStats.filter(a=>a.Stock===s),monthlyTrends:t.monthlyTrends.filter(a=>a.Stock===s),totalPredictions:t.expiryStats.filter(a=>a.Stock===s).reduce((a,i)=>a+i.PredictionCount,0),totalBreaches:t.expiryStats.filter(a=>a.Stock===s).reduce((a,i)=>a+i.BreachCount,0),overallHitRate:(()=>{const a=t.expiryStats.filter(m=>m.Stock===s),i=a.reduce((m,l)=>m+l.PredictionCount,0),o=a.reduce((m,l)=>m+l.BreachCount,0);return i>0?(i-o)/i*100:0})(),dateRange:t.summaryMetrics?{start:t.summaryMetrics.dateRangeStart,end:t.summaryMetrics.dateRangeEnd}:{start:"",end:""}}:void 0}},Kt=({data:s,stock:t,isLoading:r=!1})=>{var m,l;const a=w.useMemo(()=>s.filter(p=>p.Stock===t).sort((p,u)=>p.Date.localeCompare(u.Date)).map(p=>({date:p.Date,hitRate:Math.round(p.HitRate*100)/100,total:p.Total})),[s,t]),i=w.useMemo(()=>{if(a.length===0)return{min:0,max:100};const p=a.map(c=>c.hitRate),u=Math.min(...p),b=Math.max(...p),y=(b-u)*.1;return{min:Math.max(0,Math.floor(u-y)),max:Math.min(100,Math.ceil(b+y))}},[a]),o=w.useMemo(()=>{if(a.length===0)return{min:0,max:100};const p=a.map(b=>b.total),u=Math.max(...p);return{min:0,max:Math.ceil(u*1.2)}},[a]);return r?e.jsx("div",{className:"flex items-center justify-center h-96 bg-slate-50 rounded-lg",children:e.jsx("p",{className:"text-slate-500",children:"Loading trend data..."})}):a.length===0?e.jsx("div",{className:"flex items-center justify-center h-96 bg-slate-50 rounded-lg",children:e.jsx("p",{className:"text-slate-500",children:"No trend data available for this stock"})}):e.jsxs("div",{className:"w-full h-full",children:[e.jsx(at,{width:"100%",height:500,children:e.jsxs(rt,{data:a,margin:{top:20,right:80,bottom:60,left:60},children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"barGradient",x1:"0",y1:"0",x2:"0",y2:"1",children:[e.jsx("stop",{offset:"5%",stopColor:"#3b82f6",stopOpacity:.8}),e.jsx("stop",{offset:"95%",stopColor:"#3b82f6",stopOpacity:.2})]})}),e.jsx(it,{strokeDasharray:"3 3",stroke:"#e5e7eb"}),e.jsx(nt,{dataKey:"date",angle:-45,textAnchor:"end",height:100,tick:{fontSize:12},stroke:"#6b7280"}),e.jsx(Pe,{yAxisId:"left",label:{value:"Hit Rate (%)",angle:-90,position:"insideLeft",offset:10},domain:[i.min,i.max],tick:{fontSize:12},stroke:"#e74c3c"}),e.jsx(Pe,{yAxisId:"right",orientation:"right",label:{value:"Prediction Count",angle:90,position:"insideRight",offset:10},domain:[o.min,o.max],tick:{fontSize:12},stroke:"#3b82f6"}),e.jsx(ot,{contentStyle:{backgroundColor:"#ffffff",border:"1px solid #e5e7eb",borderRadius:"8px",padding:"12px"},formatter:(p,u)=>u==="hitRate"?[p.toFixed(2),"Hit Rate (%)"]:u==="total"?[p,"Predictions"]:[p,u],labelFormatter:p=>`Month: ${p}`}),e.jsx(lt,{wrapperStyle:{paddingTop:"20px"},verticalAlign:"bottom",height:36}),e.jsx(ct,{yAxisId:"right",dataKey:"total",name:"Prediction Count",fill:"url(#barGradient)",opacity:.7,isAnimationActive:!1}),e.jsx(dt,{yAxisId:"left",type:"monotone",dataKey:"hitRate",name:"Hit Rate (%)",stroke:"#e74c3c",strokeWidth:3,dot:{fill:"#e74c3c",r:5},activeDot:{r:7},isAnimationActive:!1})]})}),e.jsx("div",{className:"mt-4 text-sm text-slate-600",children:e.jsxs("p",{children:["Data points: ",a.length," | Date range: ",(m=a[0])==null?void 0:m.date," to"," ",(l=a[a.length-1])==null?void 0:l.date]})})]})},Vt=({data:s,dailyPredictions:t,stock:r,isLoading:a=!1})=>{const i=ut(),o=xt(),m=!i.isLoading&&i.allStockData.length>0,l=w.useMemo(()=>{if(!i.allStockData||i.allStockData.length===0)return[];const h="2024-05-01";return i.allStockData.filter(x=>x.name===r&&x.date>=h).map(x=>({date:x.date,close:x.close})).sort((x,j)=>x.date.localeCompare(j.date))},[i.allStockData,r]),p=t,u=w.useMemo(()=>{if(!o.volatilityData||o.volatilityData.length===0)return[];const h=o.volatilityData.filter(j=>j.name===r&&(j.type_of_event==="Kvartalsrapport"||j.type_of_event==="Bokslutskommuniké"));return Array.from(new Set(h.map(j=>j.date))).sort()},[o.volatilityData,r]),b=w.useMemo(()=>s.filter(h=>h.Stock===r),[s,r]),y=w.useMemo(()=>b.map(h=>{const x=parseFloat(h.LowerBound_Min),j=parseFloat(h.LowerBound_Max);let f=0;return!isNaN(x)&&!isNaN(j)&&x>0&&(f=(j-x)/x*100),{expiryDate:h.ExpiryDate,spanPercentage:f}}),[b]),c=w.useMemo(()=>{const h=Array.from(new Set(s.map(f=>f.ExpiryDate))).sort().filter(f=>f);if(h.length===0)return{tickvals:[],ticktext:[]};const x=15;let j;if(h.length<=x)j=h;else{const f=Math.floor(h.length/x);j=[];for(let k=0;k<h.length;k+=f)j.push(h[k]);j[j.length-1]!==h[h.length-1]&&j.push(h[h.length-1])}return{tickvals:j,ticktext:j}},[s]),d=w.useMemo(()=>{if(l.length===0&&b.length===0)return[];const h=[],x=b.filter(f=>(parseInt(f.BreachCount)||0)>0);x.length>0&&h.push({x:x.map(f=>f.ExpiryDate),y:x.map(f=>parseInt(f.BreachCount)),type:"bar",name:"Breach Count",marker:{color:"red",opacity:.6},yaxis:"y2",xaxis:"x1",hovertemplate:"<b>%{x|%Y-%m-%d}</b><br>Breaches: %{y}<extra></extra>"});const j=Array.from(new Set(b.map(f=>f.ExpiryDate))).sort();for(const f of j){const k=p.filter(R=>R.ExpiryDate===f),M=b.find(R=>R.ExpiryDate===f),I=M?parseFloat(M.LowerBound_Min):null,P=M?parseFloat(M.LowerBound_Max):null;if(k.length>=3){const R={x:k.map(()=>f),y:k.map(B=>{const O=parseFloat(B.LowerBound);return isNaN(O)?0:O}),type:"violin",name:"Predictions",showlegend:!1,line:{color:"blue"},fillcolor:"rgba(100, 149, 237, 0.5)",opacity:.6,meanline:{visible:!0},points:!1,hovertemplate:"%{x|%Y-%m-%d}<br>Prediction Range<extra></extra>",hoveron:"violins",scalemode:"width",spanmode:"hard",width:432e6,xaxis:"x1",yaxis:"y1"};I!==null&&P!==null&&!isNaN(I)&&!isNaN(P)&&(R.span=[I,P]),h.push(R)}}if(l.length>0&&h.push({x:l.map(f=>f.date),y:l.map(f=>f.close),mode:"lines",name:"Stock Price",line:{color:"black",width:2.5},xaxis:"x1",yaxis:"y1",hovertemplate:"<b>%{x|%Y-%m-%d}</b><br>Stock Price: %{y:.2f} SEK<extra></extra>"}),u.length>0&&l.length>0){const f=u.map(k=>{const M=l.find(P=>P.date===k);return M?M.close:l.reduce((P,R)=>{const B=Math.abs(new Date(P.date).getTime()-new Date(k).getTime());return Math.abs(new Date(R.date).getTime()-new Date(k).getTime())<B?R:P}).close});h.push({x:u,y:f,mode:"markers",name:"Earnings Events",marker:{color:"rgb(255, 165, 0)",size:12,symbol:"circle",line:{color:"rgb(255, 100, 0)",width:2.5}},xaxis:"x1",yaxis:"y1",hovertemplate:"<b>%{x|%Y-%m-%d}</b><br>Earnings Report Price: %{y:.2f} SEK<extra></extra>"})}return y.length>0&&h.push({x:y.map(f=>f.expiryDate),y:y.map(f=>f.spanPercentage),type:"bar",name:"Span %",marker:{color:"rgb(76, 175, 80)",opacity:.7},xaxis:"x2",yaxis:"y3",hovertemplate:"<b>%{x|%Y-%m-%d}</b><br>Span: %{y:.2f}%<extra></extra>"}),h},[l,b,p,u,y]),S=w.useMemo(()=>{if(l.length===0&&b.length===0)return{title:`${r} - Prediction Distribution & Breaches (No data available)`,xaxis:{title:"Date"},yaxis:{title:"Price (SEK)"},height:800,template:"plotly_white",hovermode:"x unified"};const h=l.length>0?l[0].date:"2024-05-01",x=l.length>0?l[l.length-1].date:"2024-05-01",j=b.map(R=>R.ExpiryDate).filter(R=>R),f=j.length>0?j.sort().pop():x,k=f&&f>x?f:x,M=b.reduce((R,B)=>{const O=parseInt(B.BreachCount)||0;return Math.max(R,O)},0),I=y.length>0?Math.max(...y.map(R=>R.spanPercentage)):100;return{title:`<b>${r} - Lower Bound Prediction Distribution & Breaches</b><br><sub>Blue violins = prediction distribution | Red bars = breach count | Orange dots = earnings events | Green bars = span %</sub>`,xaxis:{title:"",range:[h,k],tickformat:"%Y-%m-%d",hoverformat:"%Y-%m-%d",tickvals:c.tickvals.length>0?c.tickvals:void 0,ticktext:c.ticktext.length>0?c.ticktext:void 0,tickangle:-45,showticklabels:!1,domain:[0,1]},yaxis:{title:"Price (SEK)",side:"right",domain:[.4,1]},yaxis2:{title:"Breach Count",side:"left",overlaying:"y",showgrid:!1,range:[0,Math.max(M*3,1)],domain:[.4,1],showticklabels:!1},xaxis2:{title:"",range:[h,k],tickformat:"%Y-%m-%d",hoverformat:"%Y-%m-%d",tickvals:c.tickvals.length>0?c.tickvals:void 0,ticktext:c.ticktext.length>0?c.ticktext:void 0,tickangle:-45,showticklabels:!0,domain:[0,1],anchor:"y3"},yaxis3:{title:"Span %",side:"left",range:[0,Math.max(I*1.1,10)],domain:[0,.35],anchor:"x2"},height:1e3,template:"plotly_white",showlegend:!0,hovermode:"x unified",violinmode:"overlay",margin:{l:60,r:80,t:120,b:120}}},[l,b,y,c,r]);return a||!m?e.jsx("div",{className:"flex items-center justify-center h-96 bg-slate-50 rounded-lg",children:e.jsx("p",{className:"text-slate-500",children:"Loading distribution data..."})}):l.length===0&&b.length===0?e.jsx("div",{className:"flex items-center justify-center h-96 bg-slate-50 rounded-lg",children:e.jsx("p",{className:"text-slate-500",children:"No distribution data available for this stock"})}):e.jsxs("div",{className:"w-full",children:[d.length>0&&e.jsx(ht,{data:d,layout:S,config:{responsive:!0,displayModeBar:!0,displaylogo:!1},style:{width:"100%",height:"700px"}}),e.jsxs("div",{className:"mt-4 space-y-2 text-sm text-slate-600",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Date range:"})," ",l.length>0?`${l[0].date} to ${l[l.length-1].date}`:"N/A"," ","| ",e.jsx("strong",{children:"Total breaches:"})," ",b.reduce((h,x)=>h+x.BreachCount,0)]}),e.jsxs("p",{children:[e.jsx("span",{className:"inline-block w-3 h-3 bg-black mr-2"}),e.jsx("strong",{children:"Black line"})," = Daily stock price (all trading days)"]}),e.jsxs("p",{children:[e.jsx("span",{className:"inline-block w-3 h-3 bg-blue-500 mr-2"}),e.jsx("strong",{children:"Blue violin"})," = Prediction distribution (shown at each expiry date)"]}),e.jsxs("p",{children:[e.jsx("span",{className:"inline-block w-3 h-3 bg-red-500 mr-2"}),e.jsx("strong",{children:"Red bars"})," = Breach count per expiry date (left y-axis)"]}),e.jsxs("p",{children:[e.jsx("span",{className:"inline-block w-3 h-3 mr-2",style:{backgroundColor:"rgb(76, 175, 80)"}}),e.jsx("strong",{children:"Green bars"})," = Span percentage (range width: (max - min) / min × 100%, right y-axis)"]})]})]})},Yt=({data:s,stock:t,isLoading:r=!1})=>{const[a,i]=w.useState("ExpiryDate"),[o,m]=w.useState("desc"),l=w.useMemo(()=>s.filter(d=>d.Stock===t).sort((d,S)=>{let h,x;if(a==="hitRate"){const j=d.PredictionCount-d.BreachCount,f=S.PredictionCount-S.BreachCount;h=j/d.PredictionCount*100||0,x=f/S.PredictionCount*100||0}else h=d[a],x=S[a];return typeof h=="string"&&(h=h.toLowerCase(),x=x.toLowerCase()),h<x?o==="asc"?-1:1:h>x?o==="asc"?1:-1:0}),[s,t,a,o]),p=c=>{a===c?m(o==="asc"?"desc":"asc"):(i(c),m("asc"))},u=({field:c})=>a!==c?e.jsx(gt,{className:"w-4 h-4 text-slate-400"}):o==="asc"?e.jsx(yt,{className:"w-4 h-4 text-primary"}):e.jsx(bt,{className:"w-4 h-4 text-primary"}),b=c=>c.PredictionCount===0?0:(c.PredictionCount-c.BreachCount)/c.PredictionCount*100,y=c=>c>=85?"bg-green-50 text-green-900":c>=75?"bg-blue-50 text-blue-900":c>=65?"bg-yellow-50 text-yellow-900":"bg-red-50 text-red-900";return r?e.jsx("div",{className:"flex items-center justify-center h-64 bg-slate-50 rounded-lg",children:e.jsx("p",{className:"text-slate-500",children:"Loading table data..."})}):l.length===0?e.jsx("div",{className:"flex items-center justify-center h-64 bg-slate-50 rounded-lg",children:e.jsx("p",{className:"text-slate-500",children:"No expiry data available for this stock"})}):e.jsxs("div",{className:"w-full overflow-x-auto rounded-lg border border-slate-200",children:[e.jsxs(mt,{children:[e.jsx(pt,{className:"bg-slate-50",children:e.jsxs(Le,{children:[e.jsx(Q,{className:"cursor-pointer hover:bg-slate-100","aria-sort":a==="ExpiryDate"?o==="asc"?"ascending":"descending":void 0,children:e.jsxs(F,{variant:"ghost",size:"sm",className:"gap-2 h-8",onClick:()=>p("ExpiryDate"),children:["Expiry Date",e.jsx(u,{field:"ExpiryDate"})]})}),e.jsx(Q,{className:"text-right cursor-pointer hover:bg-slate-100","aria-sort":a==="PredictionCount"?o==="asc"?"ascending":"descending":void 0,children:e.jsxs(F,{variant:"ghost",size:"sm",className:"gap-2 h-8 ml-auto",onClick:()=>p("PredictionCount"),children:["Predictions",e.jsx(u,{field:"PredictionCount"})]})}),e.jsx(Q,{className:"text-right cursor-pointer hover:bg-slate-100","aria-sort":a==="BreachCount"?o==="asc"?"ascending":"descending":void 0,children:e.jsxs(F,{variant:"ghost",size:"sm",className:"gap-2 h-8 ml-auto",onClick:()=>p("BreachCount"),children:["Breaches",e.jsx(u,{field:"BreachCount"})]})}),e.jsx(Q,{className:"text-right cursor-pointer hover:bg-slate-100","aria-sort":a==="hitRate"?o==="asc"?"ascending":"descending":void 0,children:e.jsxs(F,{variant:"ghost",size:"sm",className:"gap-2 h-8 ml-auto",onClick:()=>p("hitRate"),children:["Hit Rate %",e.jsx(u,{field:"hitRate"})]})}),e.jsx(Q,{className:"text-right cursor-pointer hover:bg-slate-100","aria-sort":a==="LowerBound_Min"?o==="asc"?"ascending":"descending":void 0,children:e.jsxs(F,{variant:"ghost",size:"sm",className:"gap-2 h-8 ml-auto",onClick:()=>p("LowerBound_Min"),children:["Min Bound",e.jsx(u,{field:"LowerBound_Min"})]})}),e.jsx(Q,{className:"text-right cursor-pointer hover:bg-slate-100","aria-sort":a==="LowerBound_Max"?o==="asc"?"ascending":"descending":void 0,children:e.jsxs(F,{variant:"ghost",size:"sm",className:"gap-2 h-8 ml-auto",onClick:()=>p("LowerBound_Max"),children:["Max Bound",e.jsx(u,{field:"LowerBound_Max"})]})}),e.jsx(Q,{className:"text-right cursor-pointer hover:bg-slate-100","aria-sort":a==="LowerBound_Median"?o==="asc"?"ascending":"descending":void 0,children:e.jsxs(F,{variant:"ghost",size:"sm",className:"gap-2 h-8 ml-auto",onClick:()=>p("LowerBound_Median"),children:["Median",e.jsx(u,{field:"LowerBound_Median"})]})}),e.jsx(Q,{className:"text-right cursor-pointer hover:bg-slate-100","aria-sort":a==="ExpiryClosePrice"?o==="asc"?"ascending":"descending":void 0,children:e.jsxs(F,{variant:"ghost",size:"sm",className:"gap-2 h-8 ml-auto",onClick:()=>p("ExpiryClosePrice"),children:["Close Price",e.jsx(u,{field:"ExpiryClosePrice"})]})})]})}),e.jsx(ft,{children:l.map((c,d)=>{const S=b(c),h=y(S);return e.jsxs(Le,{className:"hover:bg-slate-50 transition-colors",children:[e.jsx(H,{className:"font-mono text-sm",children:c.ExpiryDate}),e.jsx(H,{className:"text-right text-sm",children:c.PredictionCount}),e.jsx(H,{className:"text-right text-sm text-red-600 font-medium",children:c.BreachCount}),e.jsx(H,{className:"text-right text-sm",children:e.jsxs("span",{className:`px-3 py-1 rounded-full font-semibold ${h}`,children:[S.toFixed(1),"%"]})}),e.jsx(H,{className:"text-right text-sm font-mono",children:c.LowerBound_Min.toFixed(2)}),e.jsx(H,{className:"text-right text-sm font-mono",children:c.LowerBound_Max.toFixed(2)}),e.jsx(H,{className:"text-right text-sm font-mono",children:c.LowerBound_Median.toFixed(2)}),e.jsx(H,{className:"text-right text-sm font-mono font-bold",children:c.ExpiryClosePrice?c.ExpiryClosePrice.toFixed(2):"N/A"})]},`${c.Stock}-${c.ExpiryDate}-${d}`)})})]}),e.jsx("div",{className:"px-6 py-4 bg-slate-50 border-t border-slate-200 text-sm text-slate-600",children:e.jsxs("p",{children:["Showing ",l.length," expir",l.length===1?"y":"ies"," | Total predictions: ",l.reduce((c,d)=>c+d.PredictionCount,0)," | Total breaches:"," ",l.reduce((c,d)=>c+d.BreachCount,0)]})})]})},Gt=({stocks:s,selectedStock:t,onStockChange:r,isLoading:a=!1})=>e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-slate-700",children:"Select Stock"}),e.jsxs(jt,{value:t,onValueChange:r,disabled:a,children:[e.jsx(vt,{className:"w-full",children:e.jsx(St,{placeholder:"Choose a stock..."})}),e.jsx(wt,{className:"max-h-64",children:s.length===0?e.jsx(_e,{value:"_none",disabled:!0,children:"No stocks available"}):s.map(i=>e.jsx(_e,{value:i,children:i},i))})]})]}),Wt=({metrics:s,isLoading:t=!1})=>{const r=[{title:"Total Options",value:s.totalOptions.toLocaleString(),icon:et,color:"bg-blue-50 text-blue-700",iconColor:"text-blue-600"},{title:"Overall Hit Rate",value:`${s.overallHitRate.toFixed(2)}%`,icon:tt,color:"bg-green-50 text-green-700",iconColor:"text-green-600"},{title:"Total Breaches",value:s.totalBreaches.toLocaleString(),icon:Ke,color:"bg-red-50 text-red-700",iconColor:"text-red-600"},{title:"Stocks Analyzed",value:s.totalStocks.toString(),icon:st,color:"bg-purple-50 text-purple-700",iconColor:"text-purple-600"}];return e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:r.map(a=>{const i=a.icon;return e.jsxs($,{className:"overflow-hidden",children:[e.jsx(K,{className:`pb-2 ${a.color}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(V,{className:"text-sm font-medium",children:a.title}),e.jsx(i,{className:`w-5 h-5 ${a.iconColor}`})]})}),e.jsx(Y,{className:"pt-4",children:t?e.jsx("div",{className:"h-8 bg-slate-200 rounded animate-pulse"}):e.jsx("div",{className:"text-2xl font-bold text-slate-900",children:a.value})})]},a.title)})})},Xt=({stock:s,totalPredictions:t,totalBreaches:r,overallHitRate:a,isLoading:i=!1})=>{const o=t>0?r/t*100:0,m=l=>l>=85?"bg-green-100 text-green-900 border-green-300":l>=75?"bg-blue-100 text-blue-900 border-blue-300":l>=65?"bg-yellow-100 text-yellow-900 border-yellow-300":"bg-red-100 text-red-900 border-red-300";return e.jsxs($,{children:[e.jsx(K,{children:e.jsxs(V,{className:"text-lg",children:[s," - Summary Statistics"]})}),e.jsx(Y,{children:i?e.jsx("div",{className:"space-y-4",children:[...Array(4)].map((l,p)=>e.jsx("div",{className:"h-4 bg-slate-200 rounded animate-pulse"},p))}):e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-xs font-semibold text-slate-600 uppercase",children:"Predictions"}),e.jsx("p",{className:"text-xl font-bold text-slate-900",children:t.toLocaleString()})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-xs font-semibold text-slate-600 uppercase",children:"Breaches"}),e.jsx("p",{className:"text-xl font-bold text-red-600",children:r.toLocaleString()})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-xs font-semibold text-slate-600 uppercase",children:"Breach Rate"}),e.jsxs("p",{className:"text-xl font-bold text-slate-900",children:[o.toFixed(1),"%"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-xs font-semibold text-slate-600 uppercase",children:"Hit Rate"}),e.jsxs("p",{className:`text-xl font-bold px-2 py-1 rounded border ${m(a)}`,children:[a.toFixed(1),"%"]})]})]})})]})},ps=()=>{const s=Ge(),[t,r]=w.useState(""),a=$t(t);w.useEffect(()=>{s.isSuccess&&s.data&&!t&&s.data.stocks.length>0&&r(s.data.stocks[0])},[s.isSuccess,s.data,t]);const i=s.isLoading||a.isLoading,o=s.isError||a.isError;return e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 py-8 px-4",children:e.jsxs("div",{className:"max-w-7xl mx-auto space-y-8",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("h1",{className:"text-4xl font-bold text-slate-900",children:"Lower Bound Validation Analysis"}),e.jsx("p",{className:"text-lg text-slate-600",children:"Analyzing IV-based lower bound predictions against historical stock prices"})]}),o&&e.jsxs(Ie,{variant:"destructive",children:[e.jsx(Ke,{className:"h-4 w-4"}),e.jsx(Ae,{children:"Error Loading Data"}),e.jsx(Oe,{children:"Failed to load lower bound analysis data. Please try refreshing the page."})]}),s.isSuccess&&s.data&&e.jsx(Wt,{metrics:s.data.summaryMetrics,isLoading:i}),e.jsxs($,{children:[e.jsx(K,{children:e.jsx(V,{className:"text-lg",children:"Analysis Controls"})}),e.jsxs(Y,{className:"space-y-6",children:[s.isSuccess&&s.data&&e.jsx(Gt,{stocks:s.data.stocks,selectedStock:t,onStockChange:r,isLoading:i}),e.jsxs(Ie,{className:"bg-blue-50 border-blue-200 text-blue-900",children:[e.jsx(kt,{className:"h-4 w-4 text-blue-600"}),e.jsx(Ae,{children:"How to Use"}),e.jsx(Oe,{children:e.jsxs("ul",{className:"list-disc list-inside space-y-1 mt-2 text-sm",children:[e.jsx("li",{children:"Select a stock from the dropdown to view its detailed analysis"}),e.jsxs("li",{children:["The ",e.jsx("strong",{children:"Trend Analysis"})," tab shows monthly hit rate evolution"]}),e.jsxs("li",{children:["The ",e.jsx("strong",{children:"Distribution"})," tab displays prediction ranges and breaches"]}),e.jsxs("li",{children:["The ",e.jsx("strong",{children:"Statistics"})," tab provides sortable per-expiry metrics"]})]})})]})]})]}),t&&a.isSuccess&&a.data&&e.jsx(Xt,{stock:t,totalPredictions:a.data.totalPredictions,totalBreaches:a.data.totalBreaches,overallHitRate:a.data.overallHitRate,isLoading:i}),t&&e.jsxs(Nt,{defaultValue:"trends",className:"w-full",children:[e.jsxs(Ct,{className:"grid w-full grid-cols-3",children:[e.jsx(ue,{value:"trends",children:"Trend Analysis"}),e.jsx(ue,{value:"distribution",children:"Distribution"}),e.jsx(ue,{value:"statistics",children:"Statistics"})]}),e.jsx(xe,{value:"trends",className:"space-y-6",children:e.jsxs($,{children:[e.jsxs(K,{children:[e.jsxs(V,{className:"text-lg",children:["Monthly Hit Rate Trends - ",t]}),e.jsx("p",{className:"text-sm text-slate-600 mt-2",children:"Hit rate evolution by expiry month with prediction volume"})]}),e.jsx(Y,{children:s.isSuccess&&s.data&&e.jsx(Kt,{data:s.data.monthlyTrends,stock:t,isLoading:i})})]})}),e.jsx(xe,{value:"distribution",className:"space-y-6",children:e.jsxs($,{children:[e.jsxs(K,{children:[e.jsxs(V,{className:"text-lg",children:["Prediction Distribution & Breaches - ",t]}),e.jsx("p",{className:"text-sm text-slate-600 mt-2",children:"Prediction ranges, span percentages, breach counts, and stock prices"})]}),e.jsx(Y,{children:a.isSuccess&&a.data&&e.jsx(Vt,{data:a.data.expiryStats,dailyPredictions:a.data.dailyPredictions,stock:t,isLoading:i})})]})}),e.jsx(xe,{value:"statistics",className:"space-y-6",children:e.jsxs($,{children:[e.jsxs(K,{children:[e.jsxs(V,{className:"text-lg",children:["Expiry Statistics - ",t]}),e.jsx("p",{className:"text-sm text-slate-600 mt-2",children:"Click column headers to sort. Hit rate color-coded: green (85%+), blue (75-85%), yellow (65-75%), red (<65%)"})]}),e.jsx(Y,{children:a.isSuccess&&a.data&&e.jsx(Yt,{data:a.data.expiryStats,stock:t,isLoading:i})})]})})]}),i&&!t&&e.jsxs("div",{className:"flex flex-col items-center justify-center py-16",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary"}),e.jsx("p",{className:"mt-4 text-slate-600",children:"Loading analysis data..."})]}),e.jsxs($,{className:"bg-slate-50 border-slate-200",children:[e.jsx(K,{children:e.jsx(V,{className:"text-sm",children:"Data Information"})}),e.jsx(Y,{className:"space-y-2 text-sm text-slate-600",children:s.isSuccess&&s.data&&e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Analysis Period:"})," ",s.data.summaryMetrics.dateRangeStart," to"," ",s.data.summaryMetrics.dateRangeEnd]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Data Source:"})," Lower bound historical validation dataset"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Methodology:"})," IV-based lower bound predictions at 1σ (68% confidence level)"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Last Updated:"})," ",new Date().toLocaleDateString()]})]})})]}),e.jsxs("div",{className:"text-center text-sm text-slate-500 pt-8 border-t border-slate-200",children:[e.jsx("p",{children:"Lower Bound Validation Analysis Dashboard"}),e.jsx("p",{className:"mt-1",children:"Built with React, Recharts, and TanStack Query"})]})]})})};export{ps as LowerBoundAnalysis};
